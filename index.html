<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skedul Gabungan Danru & Personil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; padding: 24px; }
        .document-container {
            max-width: 100%;
            margin: 0 auto 40px auto;
            background-color: white;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        .section-separator { border-top: 2px solid #e5e7eb; margin: 30px 0; padding-top: 20px; }
        .info { margin-bottom: 20px; font-size: 14px; }
        
        /* Kontainer Utama Tabel */
        .table-wrapper {
            max-height: 70vh; /* Tinggi maksimum untuk scroll vertikal */
            max-width: 100%;
            overflow: auto; /* Memungkinkan scroll horizontal dan vertikal */
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Style Tabel Inti */
        .schedule-table {
            border-collapse: collapse;
            font-size: 0.8rem;
            min-width: 100%; 
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #e5e7eb;
            padding: 8px 6px;
            text-align: center;
            white-space: nowrap; 
        }
        
        /* Freeze Panel (Kolom Stiky) */
        .schedule-table .sticky-info {
            position: sticky;
            left: 0;
            z-index: 5;
            background-color: #ecfdf5; 
            font-weight: 600;
            text-align: left;
            border-right: 2px solid #34d399; 
        }
        
        /* Freeze Header (Baris Stiky) */
        .schedule-table thead th {
            background-color: #1f2937;
            color: white;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .schedule-table thead .sticky-info {
            z-index: 15; 
            background-color: #065f46; 
        }

        /* Style per Shift (Danru & Personil) */
        .shift-p9 { background-color: #c7d2fe; color: #3730a3; font-weight: 600; } /* Danru - Pagi 9h */
        .shift-p { background-color: #bfdbfe; color: #1e40af; font-weight: 600; } /* Personil - Pagi 12h */
        .shift-m { background-color: #d1d5db; color: #374151; font-weight: 600; } /* Personil - Malam 12h */
        .shift-p8 { background-color: #a7f3d0; color: #065f46; font-weight: 600; } /* Personil - Pagi 8h */
        .shift-s8 { background-color: #fef08a; color: #b45309; font-weight: 600; } /* Personil - Siang 8h */
        .shift-m8 { background-color: #dbeafe; color: #1e3a8a; font-weight: 600; } /* Personil - Malam 8h */
        .shift-off { background-color: #fecaca; color: #b91c1c; font-weight: 700; } /* OFF (Global) */
        
        .col-nama { min-width: 180px; }
        .col-nip { min-width: 100px; }
        .col-nomor { min-width: 60px; }

        /* Style untuk Fitur Gemini */
        .gemini-feature {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .gemini-output {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #cceeff;
            background-color: #f0f8ff;
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 0.9em;
        }
        .loading { color: #007bff; font-style: italic; }
        .btn {
            padding: 8px 15px; background-color: #007bff; color: white;
            border: none; border-radius: 4px; cursor: pointer;
            font-weight: bold; transition: background-color 0.3s;
        }
        .btn:hover:not(:disabled) { background-color: #0056b3; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

<!-- ============================================== -->
<!-- SECTION 1: SKEDUL DANRU (2 Personil) -->
<!-- ============================================== -->
<div class="document-container">
    <h1 class="text-2xl font-bold mb-4 text-gray-800">Skedul DANRU (2 Orang) - Freeze Panel</h1>
    <p class="info text-gray-600">Jadwal Penjagaan DANRU (Achmad & Bachtiar) 24 Okt 2025 s/d 24 Okt 2026. Kolom NIP dan Nama akan **terkunci (freeze)**.</p>
    
    <div class="table-wrapper">
        <table id="scheduleDanruTable" class="schedule-table">
            <thead id="scheduleDanruHeader">
                <tr>
                    <th class="sticky-info col-nomor">NOMOR</th>
                    <th class="sticky-info col-nip">NIP</th>
                    <th class="sticky-info col-nama">NAMA</th>
                </tr>
                <tr id="dayDanruRow" class="text-xs">
                    <td class="sticky-info" colspan="3">Hari</td>
                </tr>
            </thead>
            <tbody id="scheduleDanruBody">
                <!-- Baris Karyawan akan diisi oleh JS -->
            </tbody>
        </table>
    </div>

    <!-- FITUR GEMINI API - DANRU -->
    <div class="gemini-feature">
        <h2 class="text-xl font-semibold mb-3 text-gray-800">Analisis Jadwal DANRU ✨</h2>
        <button id="analyzeDanruBtn" class="btn">✨ Analisis & Beri Saran</button>
        <div id="geminiDanruOutput" class="gemini-output">
            Klik tombol di atas untuk mendapatkan ringkasan pola shift DANRU dan saran optimalisasi dari Gemini AI.
        </div>
    </div>
</div>

<!-- Pemisah Antar Skedul -->
<div class="section-separator"></div>

<!-- ============================================== -->
<!-- SECTION 2: SKEDUL PERSONIL (7 Personil) -->
<!-- ============================================== -->
<div class="document-container">
    <h1 class="text-2xl font-bold mb-4 text-gray-800">Skedul PERSONIL (7 Orang) - Freeze Panel</h1>
    <p class="info text-gray-600">Jadwal Penjagaan PERSONIL (7 Orang) 31 Okt 2025 s/d 31 Okt 2026. Kolom NIP dan Nama akan **terkunci (freeze)**.</p>
    
    <div class="table-wrapper">
        <table id="schedulePersonilTable" class="schedule-table">
            <thead id="schedulePersonilHeader">
                <tr>
                    <th class="sticky-info col-nomor">NOMOR</th>
                    <th class="sticky-info col-nip">NIP</th>
                    <th class="sticky-info col-nama">NAMA</th>
                </tr>
                <tr id="dayPersonilRow" class="text-xs">
                    <td class="sticky-info" colspan="3">Hari</td>
                </tr>
            </thead>
            <tbody id="schedulePersonilBody">
                <!-- Baris Karyawan akan diisi oleh JS -->
            </tbody>
        </table>
    </div>

    <!-- FITUR GEMINI API - PERSONIL -->
    <div class="gemini-feature">
        <h2 class="text-xl font-semibold mb-3 text-gray-800">Analisis Jadwal PERSONIL ✨</h2>
        <button id="analyzePersonilBtn" class="btn">✨ Analisis & Beri Saran</button>
        <div id="geminiPersonilOutput" class="gemini-output">
            Klik tombol di atas untuk mendapatkan ringkasan pola shift personil dan saran optimalisasi dari Gemini AI.
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        const days = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        /**
         * Fungsi yang menangani retry dengan exponential backoff
         */
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { // 429 Too Many Requests, untuk ini kita retry
                        return response;
                    }
                } catch (error) {
                    // Biarkan error lain yang tidak terkait throttling lewat
                }
                // Tunggu sebelum retry
                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            throw new Error('Gagal menghubungi API setelah beberapa kali percobaan.');
        }

        /**
         * Menghitung perbedaan hari (days)
         */
        function dateDiffInDays(date1, date2) {
            const oneDay = 1000 * 60 * 60 * 24;
            // Menggunakan UTC untuk konsistensi perhitungan hari
            const utc1 = Date.UTC(date1.getFullYear(), date1.getMonth(), date1.getDate());
            const utc2 = Date.UTC(date2.getFullYear(), date2.getMonth(), date2.getDate());
            return Math.floor((utc1 - utc2) / oneDay);
        }

        // ==============================================
        // LOGIKA SKEDUL DANRU
        // ==============================================

        const DANRU_START_DATE = new Date('October 24, 2025');
        const DANRU_END_DATE = new Date('October 24, 2026');
        const DANRU_CYCLE_START_DATE = new Date('October 24, 2025'); // Hari Siklus 1

        // Pola shift 16-hari untuk Danru
        const DANRU_PATTERNS = [
            // Achmad Prihanto (Siklus 16)
            ["P9", "P9", "OFF", "OFF", "P9", "P9", "OFF", "OFF", "P9", "P9", "OFF", "OFF", "P9", "P9", "OFF", "OFF"],
            // Bachtiar (Siklus 16)
            ["OFF", "OFF", "P9", "P9", "OFF", "OFF", "P9", "P9", "OFF", "OFF", "P9", "P9", "OFF", "OFF", "P9", "P9"]
        ];
        
        const DANRU_DATA = [
            { no: 1, nip: '01007583', nama: 'Achmad Prihanto', pattern: DANRU_PATTERNS[0], shifts: [] },
            { no: 2, nip: '01009062', nama: 'Bachtiar', pattern: DANRU_PATTERNS[1], shifts: [] }
        ];

        function getDanruCycleIndex(date) {
            const diffDays = dateDiffInDays(date, DANRU_CYCLE_START_DATE);
            return (diffDays % 16 + 16) % 16; // Siklus 16 hari
        }

        function generateDanruSchedule() {
            let currentDate = new Date(DANRU_START_DATE);
            const dateHeaders = [];
            const dayNames = [];
            
            while (currentDate <= DANRU_END_DATE) {
                const cycleIndex = getDanruCycleIndex(currentDate);

                const dateString = currentDate.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: '2-digit' });
                const dayName = days[currentDate.getDay()];
                
                dateHeaders.push(dateString);
                dayNames.push(dayName);

                DANRU_DATA.forEach(danru => {
                    danru.shifts.push(danru.pattern[cycleIndex]);
                });

                const nextDate = new Date(currentDate);
                nextDate.setDate(currentDate.getDate() + 1);
                currentDate = nextDate;
            }
            renderDanruTable(dateHeaders, dayNames);
        }

        function renderDanruTable(dateHeaders, dayNames) {
            const headerRow = document.querySelector('#scheduleDanruTable thead tr:first-child');
            const dayRow = document.getElementById('dayDanruRow');
            const body = document.getElementById('scheduleDanruBody');

            dateHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });

            dayNames.forEach(day => {
                const td = document.createElement('td');
                td.textContent = day;
                dayRow.appendChild(td);
            });

            DANRU_DATA.forEach(data => {
                const row = document.createElement('tr');

                let cell = row.insertCell(); cell.textContent = data.no; cell.classList.add('sticky-info', 'col-nomor');
                cell = row.insertCell(); cell.textContent = data.nip; cell.classList.add('sticky-info', 'col-nip');
                cell = row.insertCell(); cell.textContent = data.nama; cell.classList.add('sticky-info', 'col-nama');
                
                data.shifts.forEach(shift => {
                    cell = row.insertCell();
                    cell.textContent = shift;
                    cell.classList.add(`shift-${shift.toLowerCase()}`);
                });
                body.appendChild(row);
            });
        }
        
        // --- Gemini Logika Danru ---
        async function analyzeDanruSchedule() {
            const btn = document.getElementById('analyzeDanruBtn');
            const outputDiv = document.getElementById('geminiDanruOutput');
            btn.disabled = true;
            outputDiv.innerHTML = '<span class="loading">Memproses data jadwal DANRU dengan Gemini AI...</span>';
            
            const systemPrompt = `Anda adalah seorang manajer operasional yang menganalisis jadwal shift personil. Tugas Anda adalah memberikan analisis ringkas dan saran strategis dalam Bahasa Indonesia. 
            
            Definisi Shift: P9 (Pagi 9 jam, 07.00-16.00 WIB), OFF (Libur). Pola berulang 16 hari.
            
            Berikan respons Anda dalam format Markdown Indonesia yang memiliki dua bagian:
            1. **Ringkasan Pola Siklus 16 Hari:** Jelaskan pembagian P9 dan OFF di antara kedua Danru dan komentari keadilan serta keseimbangan kerja-libur.
            2. **Saran Optimalisasi:** Berikan 1-2 saran strategis terkait pembagian shift/libur jika diperlukan.`;

            const userQuery = `Pola Danru (Achmad dan Bachtiar) adalah 2x P9, 2x OFF, berulang. Analisis pola ini dan beri saran.`; 

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, terjadi kesalahan saat menerima respons dari AI.";
                outputDiv.innerHTML = `<pre class="whitespace-pre-wrap">${generatedText}</pre>`;
            } catch (error) {
                console.error("Gemini API Error (Danru):", error);
                outputDiv.innerHTML = `<span style="color: red;">Gagal memuat analisis: ${error.message}</span>`;
            } finally {
                btn.disabled = false;
            }
        }
        document.getElementById('analyzeDanruBtn').addEventListener('click', analyzeDanruSchedule);


        // ==============================================
        // LOGIKA SKEDUL PERSONIL
        // ==============================================

        const PERSONIL_START_DATE = new Date('October 31, 2025');
        const PERSONIL_END_DATE = new Date('October 31, 2026');
        const PERSONIL_CYCLE_START_DATE = new Date('October 24, 2025'); // Hari Siklus 1 (21 hari)

        // Pola shift 21-hari untuk Personil
        const PERSONIL_PATTERNS = [
            ["OFF", "M8", "M8", "M8", "M8", "OFF", "P8", "S8", "M8", "M", "OFF", "S8", "S8", "S8", "S8", "OFF", "P8", "P8", "P8", "P8", "P8"],
            ["P", "P8", "P8", "OFF", "M8", "M8", "M8", "M8", "OFF", "P8", "S8", "M8", "M", "OFF", "S8", "S8", "S8", "S8", "P", "P8", "P8"], 
            ["OFF", "P8", "P8", "P", "P8", "P8", "OFF", "M8", "M8", "M8", "M8", "OFF", "P8", "S8", "M8", "M", "OFF", "S8", "S8", "S8", "S8"], 
            ["S8", "S8", "S8", "OFF", "P8", "P8", "P", "P8", "P8", "OFF", "M8", "M8", "M8", "M8", "OFF", "P8", "S8", "M8", "M", "OFF", "P8"], 
            ["M", "OFF", "S8", "S8", "S8", "S8", "OFF", "P8", "P8", "P", "P8", "P8", "OFF", "M8", "M8", "M8", "M8", "OFF", "P8", "S8", "M8"], 
            ["P8", "S8", "M8", "M", "OFF", "S8", "S8", "S8", "S8", "OFF", "P8", "P8", "P", "P8", "P8", "OFF", "M8", "M8", "M8", "M8", "OFF"],
            ["M8", "M8", "OFF", "P8", "S8", "M8", "M", "OFF", "S8", "S8", "S8", "S8", "OFF", "P8", "P8", "P", "P8", "P8", "OFF", "M8", "M8"] 
        ];

        const PERSONIL_DATA = [
            { no: 1, nip: '01009530', nama: 'Nur Wahyudin', pattern: PERSONIL_PATTERNS[0], shifts: [] },
            { no: 2, nip: '01009051', nama: 'Heri Riansyah', pattern: PERSONIL_PATTERNS[1], shifts: [] },
            { no: 3, nip: '01009516', nama: 'Fedinandua Rino Mansur', pattern: PERSONIL_PATTERNS[2], shifts: [] },
            { no: 4, nip: '01009538', nama: 'Rizky Nandyansyah', pattern: PERSONIL_PATTERNS[3], shifts: [] },
            { no: 5, nip: '01008955', nama: 'Yanto SUPANGAT', pattern: PERSONIL_PATTERNS[4], shifts: [] },
            { no: 6, nip: '01009510', nama: 'Andi Pratama', pattern: PERSONIL_PATTERNS[5], shifts: [] },
            { no: 7, nip: '01009520', nama: 'M. Zikri', pattern: PERSONIL_PATTERNS[6], shifts: [] }
        ];

        function getPersonilCycleIndex(date) {
            const diffDays = dateDiffInDays(date, PERSONIL_CYCLE_START_DATE);
            return (diffDays % 21 + 21) % 21; // Siklus 21 hari
        }

        function generatePersonilSchedule() {
            let currentDate = new Date(PERSONIL_START_DATE);
            const dateHeaders = [];
            const dayNames = [];
            
            while (currentDate <= PERSONIL_END_DATE) {
                const cycleIndex = getPersonilCycleIndex(currentDate);

                const dateString = currentDate.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: '2-digit' });
                const dayName = days[currentDate.getDay()];
                
                dateHeaders.push(dateString);
                dayNames.push(dayName);

                PERSONIL_DATA.forEach(personil => {
                    personil.shifts.push(personil.pattern[cycleIndex]);
                });

                const nextDate = new Date(currentDate);
                nextDate.setDate(currentDate.getDate() + 1);
                currentDate = nextDate;
            }
            renderPersonilTable(dateHeaders, dayNames);
        }

        function renderPersonilTable(dateHeaders, dayNames) {
            const headerRow = document.querySelector('#schedulePersonilTable thead tr:first-child');
            const dayRow = document.getElementById('dayPersonilRow');
            const body = document.getElementById('schedulePersonilBody');

            dateHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });

            dayNames.forEach(day => {
                const td = document.createElement('td');
                td.textContent = day;
                dayRow.appendChild(td);
            });

            PERSONIL_DATA.forEach(data => {
                const row = document.createElement('tr');

                let cell = row.insertCell(); cell.textContent = data.no; cell.classList.add('sticky-info', 'col-nomor');
                cell = row.insertCell(); cell.textContent = data.nip; cell.classList.add('sticky-info', 'col-nip');
                cell = row.insertCell(); cell.textContent = data.nama; cell.classList.add('sticky-info', 'col-nama');
                
                data.shifts.forEach(shift => {
                    cell = row.insertCell();
                    cell.textContent = shift;
                    cell.classList.add(`shift-${shift.toLowerCase()}`);
                });
                body.appendChild(row);
            });
        }
        
        // --- Gemini Logika Personil ---
        async function analyzePersonilSchedule() {
            const btn = document.getElementById('analyzePersonilBtn');
            const outputDiv = document.getElementById('geminiPersonilOutput');
            btn.disabled = true;
            outputDiv.innerHTML = '<span class="loading">Memproses data jadwal 7 personil dengan Gemini AI...</span>';
            
            const shiftDefinitions = `
                P (Pagi 12 jam): 07.00-19.00 WIB
                M (Malam 12 jam): 19.00-07.00 WIB
                P8 (Pagi 8 jam): 07.00-15.00 WIB
                S8 (Siang 8 jam): 15.00-23.00 WIB
                M8 (Malam 8 jam): 23.00-07.00 WIB
                OFF (Libur)
            `;

            const systemPrompt = `Anda adalah seorang manajer operasional yang menganalisis jadwal shift personil. Tugas Anda adalah memberikan analisis ringkas dan saran strategis dalam Bahasa Indonesia. 
            
            Berikan respons Anda dalam format Markdown Indonesia yang memiliki dua bagian utama:
            1. **Ringkasan Pola Siklus 21 Hari:** Jelaskan keragaman shift dan seberapa adil pembagian shift berat (12 jam) dan libur (OFF) di antara 7 personil dalam siklus 21 hari.
            2. **Saran Optimalisasi:** Berikan 2-3 saran strategis (dalam poin-poin) terkait rotasi dan pembagian libur/shift terberat.

            DEFINISI SHIFT: ${shiftDefinitions}`;

            const userQuery = `Berikut adalah ringkasan pola shift 7 personil yang berulang dalam siklus 21 hari. Analisis pola ini dan beri saran:
            
            - Nur: Pola unik dengan 4x M8 berturut-turut, sering mendapat M8 dan OFF.
            - Hery: Pola mencakup P (12 jam) dan shift 8 jam.
            - Riyansyah: Pola mencakup M (12 jam) dan shift 8 jam.
            - Rizky: Pola cenderung shift 8 jam (S8, P8, M8) dengan libur.
            - Yanto: Pola mencakup M (12 jam) dan shift 8 jam.
            - Andi: Rotasi P8, S8, M8, M (12 jam), lalu OFF.
            - M. Zikri: Rotasi M8, P8, S8, M (12 jam), lalu OFF.
            
            Catatan: Semua pola shift 21 hari memastikan 7 personil terdistribusi merata per hari.`; 

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });

                const result = await response.json();
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, terjadi kesalahan saat menerima respons dari AI.";
                outputDiv.innerHTML = `<pre class="whitespace-pre-wrap">${generatedText}</pre>`;
                
            } catch (error) {
                console.error("Gemini API Error (Personil):", error);
                outputDiv.innerHTML = `<span style="color: red;">Gagal memuat analisis: ${error.message}</span>`;
            } finally {
                btn.disabled = false;
            }
        }
        document.getElementById('analyzePersonilBtn').addEventListener('click', analyzePersonilSchedule);


        // --- Inisialisasi Kedua Skedul ---
        generateDanruSchedule();
        generatePersonilSchedule();
    });
</script>

</body>
</html>
